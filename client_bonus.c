/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   client_bonus.c                                     :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: mchiacha <marvin@42.fr>                    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2025/11/25 17:58:58 by mchiacha          #+#    #+#             */
/*   Updated: 2025/11/25 17:59:02 by mchiacha         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include <signal.h>
#include <unistd.h>

// Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð° Ð·Ð¼Ñ–Ð½Ð½Ð° Ð´Ð»Ñ Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½ÑŒ ("ACK")
/*
volatile Ð³Ð°Ñ€Ð°Ð½Ñ‚ÑƒÑ”, Ñ‰Ð¾ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ñ Ð·Ð¼Ñ–Ð½Ð½Ð¾Ñ— Ð·Ð¼Ñ–Ð½ÑŽÑ”Ñ‚ÑŒÑÑ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾, ÐºÐ¾Ð»Ð¸ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ ÑÐ¸Ð³Ð½Ð°Ð».
ÐšÐ»Ñ–Ñ”Ð½Ñ‚ Ð½Ðµ Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð°ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹ Ð±Ñ–Ñ‚, Ð¿Ð¾ÐºÐ¸ Ð½Ðµ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ” ACK Ð²Ñ–Ð´ ÑÐµÑ€Ð²ÐµÑ€Ð°.
*/
volatile int g_ack = 0;

// ÐžÐ±Ñ€Ð¾Ð±Ð½Ð¸Ðº Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ Ð²Ñ–Ð´ ÑÐµÑ€Ð²ÐµÑ€Ð°
/*
Ð¡ÐµÑ€Ð²ÐµÑ€ Ð¿Ñ–ÑÐ»Ñ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ Ð±ÑƒÐ´ÑŒ-ÑÐºÐ¾Ð³Ð¾ Ð±Ñ–Ñ‚Ð° Ñ€Ð¾Ð±Ð¸Ñ‚ÑŒ:
    kill(client_pid, SIGUSR1);
ÐšÐ»Ñ–Ñ”Ð½Ñ‚ Ð¿Ñ€Ð¸Ð¹Ð¼Ð°Ñ” Ñ†ÐµÐ¹ ÑÐ¸Ð³Ð½Ð°Ð» â†’ ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ g_ack = 1 â†’ Ð´Ð¾Ð·Ð²Ð¾Ð»ÑÑ” Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð¸Ñ‚Ð¸ Ð½Ð°ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹ Ð±Ñ–Ñ‚.
*/
void ack_handler(int sig)
{
    (void)sig;
    g_ack = 1;
}

// Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð±Ñ–Ñ‚Ð°
/*
ðŸ”¥ Ð¯Ðº Ñ†Ðµ Ð¿Ñ€Ð°Ñ†ÑŽÑ”:
ÑÐºÑ‰Ð¾ bit == 1 â†’ Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð»ÑÑ”Ð¼Ð¾ SIGUSR1
ÑÐºÑ‰Ð¾ bit == 0 â†’ SIGUSR2
Ð¿Ñ–ÑÐ»Ñ Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð±Ñ–Ñ‚Ð° ÐºÐ»Ñ–Ñ”Ð½Ñ‚ Ð¾Ñ‡Ñ–ÐºÑƒÑ” Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ Ð²Ñ–Ð´ ÑÐµÑ€Ð²ÐµÑ€Ð°
ÑÐµÑ€Ð²ÐµÑ€ Ð¿Ñ–ÑÐ»Ñ Ð¿Ñ€Ð¸Ð¹Ð¾Ð¼Ñƒ Ð±Ñ–Ñ‚Ð° Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ñ” Ð½Ð°Ð·Ð°Ð´ SIGUSR1
ÐºÐ»Ñ–Ñ”Ð½Ñ‚ Ð¾Ñ‚Ñ€Ð¸Ð¼ÑƒÑ” Ð¹Ð¾Ð³Ð¾ â†’ Ñ†Ð¸ÐºÐ» while (!g_ack) Ð·Ð°ÐºÑ–Ð½Ñ‡ÑƒÑ”Ñ‚ÑŒÑÑ â†’ Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð»ÑÑ”Ð¼Ð¾ Ð½Ð°ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹ Ð±Ñ–Ñ‚
Ð¦Ðµ Ð·Ð°Ð±ÐµÐ·Ð¿ÐµÑ‡ÑƒÑ” ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ñ–Ð·Ð°Ñ†Ñ–ÑŽ Ñ‚Ð° Ð·Ð°Ð¿Ð¾Ð±Ñ–Ð³Ð°Ñ” Ð²Ñ‚Ñ€Ð°Ñ‚Ñ– Ð´Ð°Ð½Ð¸Ñ….
*/
void send_bit(int pid, int bit)
{
    if (bit == 1)
        kill(pid, SIGUSR1);
    else
        kill(pid, SIGUSR2);
    while (!g_ack)
        usleep(10);
    g_ack = 0;
}

// ÐÐ°Ð´ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ñ‡Ð¸ÑÐ»Ð° (32 Ð±Ñ–Ñ‚Ð¸ PID ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð°)
/*
Ð¡ÐµÑ€Ð²ÐµÑ€ ÑÐ¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð¾Ñ‚Ñ€Ð¸Ð¼ÑƒÑ” PID ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð° (Ñ‰Ð¾Ð± Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ñ‚Ð¸ Ð½Ð°Ð·Ð°Ð´ Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ Ñ– Ñ‚.Ð´.).
ÐŸÐµÑ€ÐµÐ´Ð°Ñ”Ð¼Ð¾ Ð¹Ð¾Ð³Ð¾ Ð²Ñ–Ð´ ÑÑ‚Ð°Ñ€ÑˆÐ¾Ð³Ð¾ Ð±Ñ–Ñ‚Ð° Ð´Ð¾ Ð¼Ð¾Ð»Ð¾Ð´ÑˆÐ¾Ð³Ð¾.
*/
void send_int(int pid, unsigned int n)
{
    int i;

    i = 31;
    while (i >= 0)
    {
        send_bit(pid, (n >> i) & 1);

        i--;
    }
}

// ÐÐ°Ð´ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñƒ
// Ð¢ÑƒÑ‚ Ð°Ð½Ð°Ð»Ð¾Ð³Ñ–Ñ‡Ð½Ð¾, Ð°Ð»Ðµ Ð»Ð¸ÑˆÐµ 8 Ð±Ñ–Ñ‚ (Ð·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð¸Ð¹ ASCII ÑÐ¸Ð¼Ð²Ð¾Ð»).
void send_char(int pid, unsigned char c)
{
    int i;

    i = 7;
    while (i >= 0)
    {
        send_bit(pid, (c >> i) & 1);
        i--;
    }
}

// ÐœÑ–Ð½Ñ–Ð¼Ð°Ð»ÑŒÐ½Ð¸Ð¹ atoi. ÐŸÐ°Ñ€ÑÐ¸Ñ‚ÑŒ PID Ñƒ Ñ‡Ð¸ÑÐ»Ð¾.
int ft_atoi(const char *s)
{
    long n = 0;
    while (*s >= '0' && *s <= '9')
        n = n * 10 + (*s++ - '0');
    return ((int)n);
}

/*
ÐŸÐ¾ÐºÑ€Ð¾ÐºÐ¾Ð²Ð¾:

1. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð¸
argv[1] â†’ PID ÑÐµÑ€Ð²ÐµÑ€Ð°
argv[2] â†’ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ, ÑÐºÐµ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾ Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð¸Ñ‚Ð¸
2. Ð ÐµÑ”ÑÑ‚Ñ€ÑƒÑ”Ð¼Ð¾ Ð¾Ð±Ñ€Ð¾Ð±Ð½Ð¸Ðº Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ
signal(SIGUSR1, ack_handler);
3. ÐŸÐ¾ÑÐ¸Ð»Ð°Ñ”Ð¼Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ñƒ PID ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð°
Ð©Ð¾Ð± Ð²Ñ–Ð½ Ð¼Ñ–Ð³ Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ñ‚Ð¸ SIGUSR1 ÑÐº ACK.
4. ÐŸÐ¾ÑÐ¸Ð»Ð°Ñ”Ð¼Ð¾ Ñ‚ÐµÐºÑÑ‚ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ Ð¿Ð¾ÐºÑÐ¸Ð¼Ð²Ð¾Ð»ÑŒÐ½Ð¾
5. ÐŸÐ¾ÑÐ¸Ð»Ð°Ñ”Ð¼Ð¾ '\0' â€” ÐºÑ–Ð½ÐµÑ†ÑŒ Ñ€ÑÐ´ÐºÐ°
Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð½Ð°Ñ”, Ñ‰Ð¾ Ð¿Ð¾Ñ€Ð° Ð²Ð¸Ð²ÐµÑÑ‚Ð¸ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ Ñ– Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚Ð¸ Ð±ÑƒÑ„ÐµÑ€.
*/
int main(int argc, char **argv)
{
    int i;

    i = 0;
    if (argc != 3)
        return (1);
    signal(SIGUSR1, ack_handler);
    int pid = ft_atoi(argv[1]);
    send_int(pid, getpid());
    while (argv[2][i])
    {
        send_char(pid, argv[2][i]);
        i++;
    }
    send_char(pid, '\0');
    return (0);
}

/*
ðŸŽ¯ ÐŸÐ†Ð”Ð¡Ð£ÐœÐžÐš â€” Ð©Ðž Ð ÐžÐ‘Ð˜Ð¢Ð¬ ÐšÐ›Ð†Ð„ÐÐ¢?
Ð§Ð°ÑÑ‚Ð¸Ð½Ð°	Ð©Ð¾ Ñ€Ð¾Ð±Ð¸Ñ‚ÑŒ
send_int()	Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ñ” ÑÐµÑ€Ð²ÐµÑ€Ñƒ PID ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð°
send_char()	Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ñ” Ð¿Ð¾ 8 Ð±Ñ–Ñ‚ ÐºÐ¾Ð¶Ð½Ð¸Ð¹ ÑÐ¸Ð¼Ð²Ð¾Ð»
send_bit()	Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð»ÑÑ” Ð¾Ð´Ð¸Ð½ Ð±Ñ–Ñ‚ Ñ– Ñ‡ÐµÐºÐ°Ñ” Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ
ack_handler()	Ð¾Ñ‚Ñ€Ð¸Ð¼ÑƒÑ” Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ Ð²Ñ–Ð´ ÑÐµÑ€Ð²ÐµÑ€Ð°
Ñ†Ð¸ÐºÐ» Ð² main	Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð»ÑÑ” Ð²ÑÐµ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ Ñ– Ð½ÑƒÐ»ÑŒ-ÑÐ¸Ð¼Ð²Ð¾Ð»
*/