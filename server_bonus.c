/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   server_bonus.c                                     :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: mchiacha <marvin@42.fr>                    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2025/11/25 17:59:08 by mchiacha          #+#    #+#             */
/*   Updated: 2025/11/25 17:59:14 by mchiacha         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫
#include "./Libft/libft.h"
#include <signal.h>
#include <unistd.h>

// –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–∏ –ø–æ–≤–∏–Ω–Ω—ñ –ø–æ—á–∏–Ω–∞—Ç–∏—Å—å –Ω–∞ g_
static t_state	g_g = {0, 1, 0, 0, NULL, 0, 0, 0}; // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –∑–º—ñ–Ω–∏ (1 –≥–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–∞ –Ω–∞ —Ñ–∞–π–ª –¥–æ–∑–≤–æ–ª–µ–Ω–∞)

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –±—ñ—Ç—É, –¥–æ–ø–æ–º–æ–∂–µ –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
void	add_byte(unsigned char b)
{
	char	*new;
	size_t	i;

	i = 0;
	new = malloc(g_g.len + 2); // –°—Ç–æ–≤—Ä–µ–Ω–Ω—è –º–∞–ª–æ–∫—É —Ç–∞ –π–æ–≥–æ –∑–∞—Ö–∏—Å—Ç (–Ω–∏—â–µ)
	if (!new)
		return ;
	while (i < g_g.len)
	{
		new[i] = g_g.msg[i]; // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –Ω–∞—à –º–∞–ª–æ–∫ –Ω–∞—à–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º
		i++;
	}
	new[g_g.len] = b; 
	new[g_g.len + 1] = '\0';
	free(g_g.msg); // –û—á–∏—â—É—î–º–æ –Ω–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
	g_g.msg = new;
	g_g.len++;
}


void	reset_message(void)
{
	write(1, g_g.msg, g_g.len);
	write(1, "\n", 1);
	free(g_g.msg);
	g_g.msg = NULL;
	g_g.len = 0;
	g_g.receiving_pid = 1;
	g_g.tmp_pid = 0;
	g_g.pid_bits = 0;
	g_g.pidclient = 0;
}

// –û—Å–æ–±–∏—Å—Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—è, —á–∞—Å—Ç–∏–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É handler —è–∫–∞ –Ω–µ –≤–º—ñ—â–∞–ª–∞—Å—å —ñ–∑-–∑–∞ –ª—ñ–º—ñ—Ç—É —É 25 –ª—ñ–Ω—ñ–π
void	me(void)
{
	if (g_g.byte == '\0')
		reset_message(); // –Ø–∫—â–æ –∑—ñ–±—Ä–∞–Ω–∏–π –±–∞–π—Ç = 0 (–∫—ñ–Ω–µ—Ü—å —Ä—è–¥–∫–∞) ‚Üí –æ—á–∏—â—É—î–º–æ –±—É—Ñ–µ—Ä
	else
		add_byte(g_g.byte); // –Ü–Ω–∞–∫—à–µ –¥–æ–¥–∞—î–º–æ –±–∞–π—Ç –¥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
	g_g.byte = 0;          // –û–±–Ω—É–ª—è—î–º–æ –±–∞–π—Ç, —â–æ–± –ø–æ—á–∞—Ç–∏ –∑–±—ñ—Ä –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ
	g_g.bitcount = 0;      // –û–±–Ω—É–ª—è—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –±—ñ—Ç—ñ–≤
}

// –§—É–Ω–∫—Ü—ñ—è handler() ‚Äî –æ—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ –ø—Ä–∏–π–æ–º—É —Å–∏–≥–Ω–∞–ª—ñ–≤
/*  handler ‚Äî —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫—É –≤–∏–∫–ª–∏–∫–∞—î —è–¥—Ä–æ –∫–æ–ª–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å–∏–≥–Ω–∞–ª.
	sig ‚Äî —Ç–∏–ø —Å–∏–≥–Ω–∞–ª—É (SIGUSR1 –∞–±–æ SIGUSR2)
	info->si_pid ‚Äî PID –∫–ª—ñ—î–Ω—Ç–∞, —â–æ –Ω–∞–¥—ñ—Å–ª–∞–≤ —Å–∏–≥–Ω–∞–ª
	ctx –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —Ç–æ–º—É (void)ctx
 */
void	handler(int sig, siginfo_t *info, void *ctx)
{
	(void)ctx;
	if (g_g.receiving_pid)
	{
		// tmp_pid << 1 ‚Äî –∑—Å—É–≤–∞—î–º–æ PID –Ω–∞ –æ–¥–∏–Ω –±—ñ—Ç 
		// | (sig == SIGUSR1) - —è–∫—â–æ —Å–∏–≥–Ω–∞–ª = SIGUSR1 ‚Üí –¥–æ–¥–∞—î–º–æ –±—ñ—Ç 1 —Ç–∞ —è–∫—â–æ SIGUSR2 ‚Üí –¥–æ–¥–∞—î–º–æ 0
		g_g.tmp_pid = (g_g.tmp_pid << 1) | (sig == SIGUSR1);
		g_g.pid_bits++;
		// –ø—ñ—Å–ª—è 32 –±—ñ—Ç (int) PID –∑—ñ–±—Ä–∞–Ω–æ ‚Üí –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –π–æ–≥–æ
		if (g_g.pid_bits == 32)
		{
			g_g.pidclient = g_g.tmp_pid;
			g_g.receiving_pid = 0;
			g_g.tmp_pid = 0;
			g_g.pid_bits = 0;
		}
	}
	// –ó–±—ñ—Ä –±–∞–π—Ç—ñ–≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
	else
	{
		// (g_g.byte << 1) ‚Äî –∑—Å—É–≤–∞—î–º–æ –±–∞–π—Ç –≤–ª—ñ–≤–æ
		// | (sig == SIGUSR1) ‚Äî –¥–æ–¥–∞—î–º–æ –±—ñ—Ç 1 –∞–±–æ 0
		g_g.byte = (g_g.byte << 1) | (sig == SIGUSR1);
		g_g.bitcount++;
		// –ö–æ–ª–∏ –Ω–∞–∑–±–∏—Ä–∞–ª–æ—Å—å 8 –±—ñ—Ç, –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è me() ‚Äî –æ–±—Ä–æ–±–∫–∞ –≥–æ—Ç–æ–≤–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
		if (g_g.bitcount == 8)
			me();
	}
	// –í—ñ–¥–ø–æ–≤—ñ–¥—å –∫–ª—ñ—î–Ω—Ç—É (ACK)
	// –ü–û–Ø–°–ù–ï–ù–ù–Ø:
	// - –°–µ—Ä–≤–µ—Ä –∑–∞–≤–∂–¥–∏ –Ω–∞–¥—Å–∏–ª–∞—î –∫–ª—ñ—î–Ω—Ç—É —Å–∏–≥–Ω–∞–ª –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è:
	//   - –ö–ª—ñ—î–Ω—Ç —á–µ–∫–∞—î ACK –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –±—ñ—Ç–∞
	//   - –¶–µ –∑–∞–ø–æ–±—ñ–≥–∞—î –≤—Ç—Ä–∞—Ç—ñ —Å–∏–≥–Ω–∞–ª—ñ–≤
	kill(info->si_pid, SIGUSR1);
}

int	main(void)
{
	// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –ø—ñ–¥ –Ω–∞–∑–≤–æ—é sa 
	struct sigaction	sa;

	ft_putnbr(getpid()); // –í–∏–≤–æ–¥–∏–º–æ –Ω–∞—à pid 
	write(1, "\n", 1); 
	// –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫–∞ —Å–∏–≥–Ω–∞–ª—ñ–≤
	// sa_sigaction ‚Äî —Ä–æ–∑—à–∏—Ä–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è –æ–±—Ä–æ–±–Ω–∏–∫–∞ (–¥–æ—Å—Ç—É–ø –¥–æ siginfo_t)
	// SA_SIGINFO ‚Äî –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ –¥–ª—è siginfo_t
	sa.sa_sigaction = handler; // –ø—ñ–¥–ø–∏—Å—É—î–º–æ —Å–∏–≥–Ω–∞–ª –Ω–∞ handler
	sa.sa_flags = SA_SIGINFO;
	sigemptyset(&sa.sa_mask); 
	sigaction(SIGUSR1, &sa, NULL);
	sigaction(SIGUSR2, &sa, NULL);
	// –ù–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–µ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –±—ñ—Ç—ñ–≤, —Ü–µ –æ—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª —Å–µ—Ä–≤–µ—Ä–∞
	while (1)
		pause(); // pause() —á–µ–∫–∞—î —Å–∏–≥–Ω–∞–ª
}

/*
üéØ –ü–Ü–î–°–£–ú–û–ö (–ø—Ä–æ—Å—Ç–æ—é –º–æ–≤–æ—é)

–°–µ—Ä–≤–µ—Ä Minitalk –ø—Ä–∞—Ü—é—î —Ç–∞–∫:

1Ô∏è‚É£ –í–∏–≤–æ–¥–∏—Ç—å —Å–≤—ñ–π PID
2Ô∏è‚É£ –ß–µ–∫–∞—î —Å–∏–≥–Ω–∞–ª–∏ SIGUSR1 / SIGUSR2
3Ô∏è‚É£ SIGUSR1 = –±—ñ—Ç 1
4Ô∏è‚É£ SIGUSR2 = –±—ñ—Ç 0
5Ô∏è‚É£ –ó–±–∏—Ä–∞—î 32 –±—ñ—Ç–∏ ‚Üí PID –∫–ª—ñ—î–Ω—Ç–∞
6Ô∏è‚É£ –ü–æ—Ç—ñ–º –∑–±–∏—Ä–∞—î –∫–æ–∂–Ω—ñ 8 –±—ñ—Ç ‚Üí —Å–∏–º–≤–æ–ª
7Ô∏è‚É£ –Ø–∫—â–æ —Å–∏–º–≤–æ–ª = \0 ‚Üí –∫—ñ–Ω–µ—Ü—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
8Ô∏è‚É£ –ü—ñ—Å–ª—è –∫–æ–∂–Ω–æ–≥–æ –±—ñ—Ç–∞ —Å–µ—Ä–≤–µ—Ä –Ω–∞–¥—Å–∏–ª–∞—î ACK –Ω–∞–∑–∞–¥ –∫–ª—ñ—î–Ω—Ç—É
*/